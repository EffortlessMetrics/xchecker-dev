name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  dependency-policy:
    name: Dependency Policy Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Validate hybrid dependency policy
        run: |
          echo "=== Validating Hybrid Dependency Policy ==="
          python3 - <<'PY'
          from pathlib import Path
          import re
          import sys

          try:
              import tomllib
          except ModuleNotFoundError:  # Python < 3.11
              try:
                  import tomli as tomllib
              except ModuleNotFoundError:
                  print("tomllib not available (need Python 3.11+ or tomli).", file=sys.stderr)
                  sys.exit(2)

          SECURITY_CRITICAL = {
              "reqwest": "=0.12.28",
              "tokio": "=1.49.0",
              "serde": "=1.0.228",
              "serde_json": "=1.0.148",
              "blake3": "=1.8.2",
          }

          CORE_DEPS = {
              "clap": "4.5",
              "anyhow": "1.0",
              "thiserror": "2.0",
              "tracing": "0.1",
          }

          def read_version(deps, name):
              spec = deps.get(name)
              if isinstance(spec, str):
                  return spec.strip()
              if isinstance(spec, dict):
                  version = spec.get("version")
                  if isinstance(version, str):
                      return version.strip()
              return None
          def extract_version(req):
              if not req:
                  return None
              match = re.search(r"\d+\.\d+(?:\.\d+)?", req)
              return match.group(0) if match else None

          data = tomllib.loads(Path("Cargo.toml").read_text())
          deps = data.get("dependencies", {})

          errors = []

          print("Checking security-critical dependency versions...")
          for name, expected in SECURITY_CRITICAL.items():
              version = read_version(deps, name)
              if version is None:
                  errors.append(f"{name}: missing from Cargo.toml")
                  continue
              if version != expected and version != f"={expected}":
                  errors.append(f"{name}: expected exact {expected}, found {version}")
              else:
                  print(f"OK {name}: exact version {expected}")

          print("\nChecking core dependency coarse minima...")
          for name, minimum in CORE_DEPS.items():
              version = read_version(deps, name)
              if version is None:
                  errors.append(f"{name}: missing from Cargo.toml")
                  continue
              found = extract_version(version)
              if found is None or not found.startswith(minimum):
                  errors.append(f"{name}: expected minimum {minimum}, found {version}")
              else:
                  print(f"OK {name}: coarse minimum {minimum} (found {version})")

          if errors:
              print("\nPolicy validation failed:")
              for error in errors:
                  print(f"- {error}")
              sys.exit(1)

          print("\nHybrid dependency policy validation passed")
          PY

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: dependency-policy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        # Enforcing -D warnings as of v1.0 release
        run: cargo clippy --all-targets --all-features -- -D warnings

  test-serial:
    name: Test (Serial - Required)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    needs: dependency-policy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run tests (serial)
        run: cargo test --all-features -- --test-threads=1

      - name: WSL probe test (Windows only)
        if: runner.os == 'Windows'
        run: cargo test test_wsl_probe -- --ignored --nocapture
        continue-on-error: true

  test-parallel:
    name: Test (Parallel - Non-blocking)
    # PLAN:
    # 1. Keep as non-blocking (continue-on-error: true) initially to validate stability
    # 2. After 3 consecutive green runs, flip to required (remove continue-on-error)
    # 3. After 1 week of stable parallel runs, drop test-serial lane
    # Currently non-blocking to validate parallel test stability
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    needs: dependency-policy
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run tests (parallel)
        run: cargo test --all-features

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run schema validation tests
        run: cargo test test_generated_outputs_validate_against_schemas

      - name: Run M3 gate contracts validation
        run: cargo test --test m3_gate_contracts_validation

      - name: Run comprehensive schema compliance tests
        run: cargo test --test test_schema_compliance

      - name: Verify schema examples validate
        run: cargo test --test test_json_schema_validation

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run secret scanning tests with controls
        run: cargo test test_secret_scanning_ci_validation

      - name: Verify positive control fails scanner
        run: cargo test test_positive_control_fake_secrets_detected

      - name: Verify negative control passes scanner
        run: cargo test test_negative_control_clean_file_passes

      - name: Run redaction security tests
        run: cargo test --test test_redaction_security

  docs-conformance:
    name: Documentation Conformance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run documentation validation tests
        run: cargo test --test test_doc_validation -- --test-threads=1

      - name: Verify generated schema examples are fresh
        run: |
          git diff --exit-code docs/schemas/ || {
            echo "âŒ Generated schema examples are out of sync!"
            echo ""
            echo "Run 'cargo test --test test_doc_validation doc_validation::schema_examples_tests -- --nocapture' to regenerate and commit updated files under docs/schemas/*"
            echo ""
            exit 1
          }

  gate-validation:
    name: Gate Command Validation
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run gate unit tests
        run: cargo test gate --lib

      - name: Run gate JSON schema validation
        run: cargo test --test test_json_schema_validation gate

  test-real:
    name: Test (Real - With Claude)
    runs-on: ubuntu-latest
    # Only run on main branch pushes and when secret is available
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.ANTHROPIC_API_KEY != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run smoke tests
        run: cargo test --test smoke -- --ignored
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
