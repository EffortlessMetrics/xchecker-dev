# Test Workflow - Fast and Full test lanes
#
# This workflow implements the test-fast and test-full lanes:
# - test-fast: Runs on every PR for quick feedback (~30s)
# - test-full: Runs nightly and on main branch for comprehensive coverage
#
# See docs/TESTING.md for test lane documentation.

name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_lane:
        description: 'Test lane to run'
        required: true
        default: 'fast'
        type: choice
        options:
          - fast
          - full

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # TEST-FAST: Quick feedback on every PR (~30s)
  # ============================================================================
  test-fast:
    name: Test Fast (${{ matrix.os }})
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.test_lane == 'fast')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run test-fast (lib + bins)
        run: cargo test --lib --bins --locked

  # ============================================================================
  # TEST-FULL: Comprehensive testing (nightly + main branch)
  # ============================================================================
  test-full:
    name: Test Full (${{ matrix.os }})
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.test_lane == 'full')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-full-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-full-
            ${{ runner.os }}-cargo-

      - name: Run test-full (all tests) - Locked
        run: cargo test --all-features --locked
        env:
          # Increase property test cases for nightly runs
          PROPTEST_CASES: 128

      - name: Run test-full (all tests) - Fresh Resolve (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          if command -v ld.lld >/dev/null 2>&1 || command -v lld >/dev/null 2>&1; then
            if [ -n "${RUSTFLAGS:-}" ]; then
              export RUSTFLAGS="$RUSTFLAGS -C link-arg=-fuse-ld=lld"
            else
              export RUSTFLAGS="-C link-arg=-fuse-ld=lld"
            fi
          fi
          export CARGO_PROFILE_TEST_DEBUG=0
          export CARGO_PROFILE_DEV_DEBUG=0
          export CARGO_BUILD_JOBS=1
          export CARGO_INCREMENTAL=0

          cargo update
          cargo test --all-features
        env:
          # Increase property test cases for nightly runs
          PROPTEST_CASES: 128

      - name: Run test-full (all tests) - Fresh Resolve (non-Linux)
        if: runner.os != 'Linux'
        run: |
          cargo update
          cargo test --all-features
        env:
          # Increase property test cases for nightly runs
          PROPTEST_CASES: 128

      - name: Run doc tests
        run: cargo test --doc

  # ============================================================================
  # PROPERTY TESTS: Dedicated property-based testing job
  # ============================================================================
  property-tests:
    name: Property Tests
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.test_lane == 'full')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ubuntu-cargo-pbt-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-pbt-
            ubuntu-cargo-

      - name: Run property-based tests
        run: cargo test --test property_based_tests
        env:
          # Use higher case count for CI
          PROPTEST_CASES: 256

      - name: Run doctor HTTP provider property tests
        run: cargo test --test test_doctor_http_provider_checks
        env:
          PROPTEST_CASES: 128

  # ============================================================================
  # STUB TESTS: Integration tests with claude-stub
  # ============================================================================
  # NOTE: This job runs on PRs for visibility but is NOT required in branch protection.
  # It provides early signal for stub-dependent issues without blocking merges.
  # Plan: After 3 consecutive stable weeks, consider making this required.
  stub-tests:
    name: Stub Integration Tests (non-blocking)
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.test_lane == 'full')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ubuntu-cargo-stub-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-stub-
            ubuntu-cargo-

      - name: Build claude-stub
        run: cargo build --bin claude-stub --features dev-tools

      - name: Add claude-stub to PATH as claude
        run: |
          # Create a symlink so tests can find 'claude' in PATH
          mkdir -p $HOME/.local/bin
          ln -sf $PWD/target/debug/claude-stub $HOME/.local/bin/claude
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run stub integration tests
        run: |
          # Run serially to avoid race conditions from tests that use set_current_dir
          # Tests with #[ignore] that change CWD interfere when run in parallel
          cargo test --tests -- \
            --test-threads=1 \
            --include-ignored \
            --skip requires_real_claude \
            --skip requires_xchecker_binary \
            --skip requires_future_phase \
            --skip requires_future_api \
            --skip requires_refactoring \
            --skip windows_ci_only
        env:
          XCHECKER_E2E: "1"

  # ============================================================================
  # EXAMPLE VALIDATION: Validate showcase examples
  # ============================================================================
  example-validation:
    name: Example Validation (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate fullstack-nextjs example (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x examples/fullstack-nextjs/scripts/validate.sh
          ./examples/fullstack-nextjs/scripts/validate.sh

      - name: Validate fullstack-nextjs example (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          .\examples\fullstack-nextjs\scripts\validate.ps1

      - name: Validate mono-repo example (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x examples/mono-repo/scripts/validate.sh
          ./examples/mono-repo/scripts/validate.sh

      - name: Validate mono-repo example (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          .\examples\mono-repo\scripts\validate.ps1

  # ============================================================================
  # WALKTHROUGH VALIDATION: Validate walkthrough code snippets
  # ============================================================================
  walkthrough-validation:
    name: Walkthrough Validation (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate walkthrough snippets (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/validate_walkthrough_snippets.sh
          ./scripts/validate_walkthrough_snippets.sh

      - name: Validate walkthrough snippets (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          .\scripts\validate_walkthrough_snippets.ps1
